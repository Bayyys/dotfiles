#!/usr/bin/env bash
set -euo pipefail

log() { printf '[install-zim] %s\n' "$1"; }

INSTALLED=()
UPDATED=()
SKIPPED=()
FAILED=()
add_i() { INSTALLED+=("$1"); }
add_u() { UPDATED+=("$1"); }
add_s() { SKIPPED+=("$1"); }
add_f() { FAILED+=("$1"); }

print_list() {
  local title="$1"; shift || true
  printf '\n[install-zim] %s\n' "$title"
  if [ "$#" -eq 0 ]; then
    echo "  - (none)"
    return
  fi
  local x
  for x in "$@"; do echo "  - $x"; done
}

summary() {
  local restore_nounset=0
  case $- in
    *u*)
      restore_nounset=1
      set +u
      ;;
  esac

  print_list "Installed" "${INSTALLED[@]}"
  print_list "Updated" "${UPDATED[@]}"
  print_list "Skipped" "${SKIPPED[@]}"
  print_list "Failed" "${FAILED[@]}"

  if [ "$restore_nounset" -eq 1 ]; then
    set -u
  fi

  [ "${#FAILED[@]}" -eq 0 ]
}

has_cmd() { command -v "$1" >/dev/null 2>&1; }

run_zim() {
  local zim_home="$1"
  local action="$2"
  ZDOTDIR="${ZDOTDIR:-$HOME}" ZIM_HOME="$zim_home" zsh -lc "source \"\${ZIM_HOME}/zimfw.zsh\" $action"
}

main() {
  if ! has_cmd zsh; then
    add_f "zsh missing"
    summary
    return 1
  fi

  local zim_home="${ZDOTDIR:-$HOME}/.zim"
  local zimfw="${zim_home}/zimfw.zsh"
  local zimrc="${ZDOTDIR:-$HOME}/.zimrc"
  local url="https://github.com/zimfw/zimfw/releases/latest/download/zimfw.zsh"
  local already_installed=0

  if [ ! -f "$zimfw" ]; then
    mkdir -p "$zim_home"
    if has_cmd curl; then
      curl -fsSL --create-dirs -o "$zimfw" "$url"
      add_i "zimfw"
    elif has_cmd wget; then
      wget -nv -O "$zimfw" "$url"
      add_i "zimfw"
    else
      add_f "zimfw install (curl/wget missing)"
      summary
      return 1
    fi
  else
    already_installed=1
    add_s "zimfw (already installed)"
  fi

  if [ -f "$zimrc" ]; then
    if run_zim "$zim_home" init; then
      add_u "zim modules (init from ~/.zimrc)"
    else
      add_f "zim modules init"
    fi

    if [ "$already_installed" -eq 1 ]; then
      if run_zim "$zim_home" update; then
        add_u "zim modules (update)"
      else
        add_s "zim modules update (failed, non-fatal)"
      fi
    fi
  else
    add_s "zim module init (~/.zimrc missing)"
  fi

  summary
}

main "$@"
