#!/usr/bin/env bash
set -euo pipefail

if [ -z "${BASH_VERSION:-}" ]; then
  if command -v bash >/dev/null 2>&1; then
    exec "$(command -v bash)" "$0" "$@"
  fi
  echo "[install-cli] bash is required to run this script" >&2
  exit 1
fi

log() { printf '[install-cli] %s\n' "$1"; }
has_cmd() { command -v "$1" >/dev/null 2>&1; }

INSTALLED_ITEMS=()
UPDATED_ITEMS=()
SKIPPED_ITEMS=()
FAILED_ITEMS=()
record_installed() { INSTALLED_ITEMS+=("$1"); }
record_updated() { UPDATED_ITEMS+=("$1"); }
record_skipped() { SKIPPED_ITEMS+=("$1"); }
record_failed() { FAILED_ITEMS+=("$1"); }

print_list() {
  local title="$1"
  shift || true
  printf '\n[install-cli] %s\n' "$title"
  if [ "$#" -eq 0 ]; then
    echo "  - (none)"
    return
  fi
  local item
  for item in "$@"; do
    echo "  - $item"
  done
}

print_summary() {
  local restore_nounset=0
  case $- in
    *u*)
      restore_nounset=1
      set +u
      ;;
  esac

  printf '\n[install-cli] Summary\n'
  print_list "Installed" "${INSTALLED_ITEMS[@]}"
  print_list "Updated" "${UPDATED_ITEMS[@]}"
  print_list "Skipped" "${SKIPPED_ITEMS[@]}"
  print_list "Failed" "${FAILED_ITEMS[@]}"

  if [ "$restore_nounset" -eq 1 ]; then
    set -u
  fi

  if [ "${#FAILED_ITEMS[@]}" -gt 0 ]; then
    log "completed with failures"
    return 1
  fi
  log "completed successfully"
}

SUDO=""
if [ "$(id -u)" -ne 0 ] && has_cmd sudo; then
  SUDO="sudo"
fi

PKG_MANAGER=""
APT_UPDATED=0

detect_pkg_manager() {
  if has_cmd brew; then
    PKG_MANAGER="brew"
  elif has_cmd apt-get; then
    PKG_MANAGER="apt"
  elif has_cmd dnf; then
    PKG_MANAGER="dnf"
  elif has_cmd yum; then
    PKG_MANAGER="yum"
  elif has_cmd pacman; then
    PKG_MANAGER="pacman"
  elif has_cmd zypper; then
    PKG_MANAGER="zypper"
  elif has_cmd apk; then
    PKG_MANAGER="apk"
  fi
}

install_pkg() {
  local pkg="$1"
  case "$PKG_MANAGER" in
    brew)
      brew install "$pkg"
      ;;
    apt)
      if [ "$APT_UPDATED" -eq 0 ]; then
        $SUDO apt-get update
        APT_UPDATED=1
        record_updated "apt package index"
      fi
      $SUDO apt-get install -y "$pkg"
      ;;
    dnf)
      $SUDO dnf install -y "$pkg"
      ;;
    yum)
      $SUDO yum install -y "$pkg"
      ;;
    pacman)
      $SUDO pacman -Sy --noconfirm --needed "$pkg"
      ;;
    zypper)
      $SUDO zypper --non-interactive install "$pkg"
      ;;
    apk)
      $SUDO apk add --no-cache "$pkg"
      ;;
    *)
      return 1
      ;;
  esac
}

install_if_missing() {
  local cmd_name="$1"
  shift

  if has_cmd "$cmd_name"; then
    record_skipped "$cmd_name (already installed)"
    return 0
  fi

  local pkg
  for pkg in "$@"; do
    if install_pkg "$pkg" >/dev/null 2>&1 && has_cmd "$cmd_name"; then
      record_installed "$cmd_name (package: $pkg)"
      return 0
    fi
  done

  record_failed "$cmd_name"
  return 1
}

configure_fzf_shell_integration() {
  if ! has_cmd fzf; then
    record_skipped "fzf shell integration (fzf not installed)"
    return
  fi

  local prefix=""
  if has_cmd brew; then
    prefix="$(brew --prefix 2>/dev/null || true)"
  fi

  if [ -n "$prefix" ] && [ -x "$prefix/opt/fzf/install" ]; then
    "$prefix/opt/fzf/install" --key-bindings --completion --no-update-rc
    record_updated "fzf shell integration"
  else
    record_skipped "fzf shell integration (installer not found)"
  fi
}

main() {
  detect_pkg_manager
  if [ -z "$PKG_MANAGER" ]; then
    record_failed "package manager detection"
    print_summary
    return 1
  fi

  log "package-manager=${PKG_MANAGER}"

  install_if_missing git git || true
  install_if_missing curl curl || true
  install_if_missing wget wget || true
  install_if_missing vim vim || true
  install_if_missing fzf fzf || true
  install_if_missing zoxide zoxide || true
  install_if_missing eza eza || true
  install_if_missing bat bat batcat || true
  install_if_missing tree tree || true
  install_if_missing tldr tldr || true

  if has_cmd exa; then
    record_skipped "exa (already installed)"
  elif install_pkg exa >/dev/null 2>&1 && has_cmd exa; then
    record_installed "exa (optional)"
  else
    record_skipped "exa (optional package unavailable)"
  fi

  configure_fzf_shell_integration
  print_summary
}

main "$@"
